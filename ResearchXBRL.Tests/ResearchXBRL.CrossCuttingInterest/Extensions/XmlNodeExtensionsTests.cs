using ResearchXBRL.CrossCuttingInterest.Extensions;
using System;
using System.Linq;
using System.Xml;
using Xunit;

namespace ResearchXBRL.Tests.ResearchXBRL.CrossCuttingInterest.Extensions
{
    public sealed class XmlNodeExtensionsTests
    {
        public sealed class GetChildNodesTests
        {
            [Fact]
            public void 全ての子要素を列挙する()
            {
                // arrange
                var sampleAttributes = Enumerable.Repeat("sample", 3).ToArray();
                var targetId = "test-main";
                var xml = $@"
<!DOCTYPE root [
    <!ELEMENT root ANY>
    <!ELEMENT link:linkbase ANY>
    <!ATTLIST link:linkbase SSN ID #REQUIRED>]>
<!-- Generated by PRONEXUS WORKS -->
<root> 
    <link:linkbase SSN=""{targetId}"" xmlns:link=""http://www.xbrl.org/2003/linkbase"">
      <link:roleRef type=""{sampleAttributes[0]}"" />
      <link:roleRef type=""{sampleAttributes[1]}"" />
      <link:roleRef type=""{sampleAttributes[2]}"" />
    </link:linkbase>
</root>";
                var xmlDocument = CreateXMLObject(xml);

                // act
                var acutal = xmlDocument
                    .GetElementById("test-main")?
                    .GetChildNodes()
                    .ToArray()
                    ?? throw new Exception("要素取得失敗");

                // assert
                Assert.Equal(3, acutal.Count());
                Assert.Equal(sampleAttributes[0], acutal[0].Attributes?["type"]?.Value);
                Assert.Equal(sampleAttributes[1], acutal[1].Attributes?["type"]?.Value);
                Assert.Equal(sampleAttributes[2], acutal[2].Attributes?["type"]?.Value);
            }
        }

        public sealed class GetAttributeValueTests
        {
            [Fact]
            public void 指定した属性名属性値を取得する()
            {
                // arrange
                var targetId = "test-main";
                var attribteName = "type";
                var expectedAttributeValue = "sample1";
                var xml = $@"
<!DOCTYPE root [
    <!ELEMENT root ANY>
    <!ELEMENT link:roleRef ANY>
    <!ATTLIST link:roleRef SSN ID #REQUIRED>]>
<!-- Generated by PRONEXUS WORKS -->
<root> 
    <link:linkbase xmlns:link=""http://www.xbrl.org/2003/linkbase"">
      <link:roleRef SSN=""{targetId}"" {attribteName}=""{expectedAttributeValue}"" />
      <link:roleRef {attribteName}=""sample2"" />
      <link:roleRef {attribteName}=""sample3"" />
    </link:linkbase>
</root>";
                var xmlDocument = CreateXMLObject(xml);
                var element = xmlDocument.GetElementById("test-main")
                    ?? throw new Exception("要素取得失敗");

                // act
                var acutal = element.GetAttribute("type");

                // assert
                Assert.Equal(expectedAttributeValue, acutal);
            }
        }

        private static XmlDocument CreateXMLObject(string xml)
        {
            var xmlDocument = new XmlDocument();
            xmlDocument.LoadXml(xml.Trim());
            return xmlDocument;
        }
    }
}
